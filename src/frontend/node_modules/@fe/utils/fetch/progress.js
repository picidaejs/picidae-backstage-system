/**
 * @file: progress
 * @author: Cuttle Cong
 * @date: 2017/12/14
 * @description:
 */

// eslint-disable-next-line no-unused-vars
module.exports = function (response, [url, { progress }]) {

  if (typeof progress === 'function') {
    let totalLength = response.headers.get('content-length')
    totalLength = totalLength && parseFloat(totalLength)
    const reader = response.body.getReader()
    let bytesReceived = 0

    // read() returns a promise that resolves
    // when a value has been received
    return reader.read().then(function processResult(result) {
      // Result objects contain two properties:
      // done  - true if the stream has already given
      //         you all its data.
      // value - some data. Always undefined when
      //         done is true.
      if (result.done) {
        if (totalLength !== bytesReceived) {
          progress(bytesReceived, bytesReceived)
        }
        return
      }
      // result.value for fetch streams is a Uint8Array
      bytesReceived += result.value.length
      progress(bytesReceived, totalLength)

      // Read some more, and call this function again
      return reader.read().then(processResult)
    })
  }
}