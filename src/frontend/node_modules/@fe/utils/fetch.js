/**
 * @file: fetch
 * @author: Cuttle Cong
 * @date: 2017/12/11
 * @description:
 */
require('isomorphic-fetch')

const fetch = global.fetch

module.exports = global.fetch = async (url, options = {}, type = 'json') => {
  if (typeof options === 'string') {
    type = options
    options = {}
  }
  const {
    toastError = true,
    ...restOptions
  } = options

  if (type === 'json') {
    restOptions.credentials = restOptions.credentials || 'include'
    restOptions.headers = new Headers({
      'Cache-Control': 'no-cache,no-store,must-revalidate,max-age=-1',
      ...restOptions.headers,
      'Content-Type': 'application/json;charset=UTF-8'
    })
    if (restOptions.body instanceof Object) {
      restOptions.body = JSON.stringify(restOptions.body)
    }
  }

  try {
    let res = await fetch(url, restOptions)
    return res[type]()
  } catch (err) {
    if (toastError) {
      // TODO toast-style
      alert('Error ' + err.message)
    }
    throw err
  }
}
