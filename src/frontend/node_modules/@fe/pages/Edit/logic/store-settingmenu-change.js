/**
 * @file: proxy-settingmenu-change
 * @author: Cuttle Cong
 * @date: 2017/12/14
 * @description:
 */
import BrowserLocalStorage from '@fe/utils/BrowserLocalStorage'

const storage = new BrowserLocalStorage('ace_setting')

function initialFromStorage(editor) {
  let keys = storage.keys()
  keys.forEach(key => {
    let method = null
    if (typeof editor[key] === 'function') {
      method = editor[key].bind(editor)
    } else if (typeof editor.getSession()[key] === 'function') {
      method = editor.getSession()[key].bind(editor.getSession())
    }
    method && method(storage[key])
  })
}


function setProxy(elem = document.querySelector('#ace_settingsmenu'), editor) {
  if (!elem || !elem.addEventListener) return

  elem.addEventListener('change', function (evt) {
    let { name, value, tagName, type } = evt.target
    const lowerTagname = tagName.toLowerCase()
    if (lowerTagname === 'checkbox' || type === 'checkbox') {
      value = evt.target.checked
    } else if (lowerTagname === 'radio' || type === 'radio') {
      value = evt.target.checked
    }

    if (
      typeof editor[name] === 'function' ||
      typeof editor.getSession()[name] === 'function'
    ) {
      storage[name] = value
    }
  })
}

module.exports = {
  setProxy,
  initialFromStorage,
  clear: storage.clear
}